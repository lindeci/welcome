从0到1 OceanBase原生分布式数据库内核实战进阶版.pdf

https://obcommunity-private-oss.oceanbase.com/prod/blog/2023-09/%E4%BB%8E0%E5%88%B01%20OceanBase%E5%8E%9F%E7%94%9F%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E5%86%85%E6%A0%B8%E5%AE%9E%E6%88%98%E8%BF%9B%E9%98%B6%E7%89%88.pdf

# 优化器框架介绍
目前业界最常用的优化器框架有两个：
- 以 IBM 为代表的 System-R 框架，像 Oracle 和 PG，以及 OceanBase 使用的都是这个框架。

在这个框架中，当数据库接收到一条 SQL 后会通过 Parser 和 Resolver 把 SQL 转成一个形式化的数据结构
statement 来描述原始的 SQL。接下来优化器会以这个 statement 作为输入，对这条 SQL 进行查询改写。
这里做的事情实际上就是在不断的改写这个数据结构，得到一个最终的 statement。该 statement 会经过一
个基于动态规划的计划生成器来得到最终的物理执行计划
- Cascade 框架，SQL Server 使用的就是这个改写框架。

在这个框架中，Parser 和 Resolver 结束后，直接得到的就是一个逻辑计划树，然后通过一系列的规则体系
改写这个计划树来得到最终的执行计划。所以这个改写规则就包含了很多内容，比如说它既包含了通常说的
一些改写规则，也包含了计划生成的一些优化规则。然后它会不断去迭代，直到收敛，或者是通过基于规则
的一些控制，来保证迭代不会无限地循环下去。

查询改写部分有基于规则的改写和基于代价的改写

代价模型和统计信息这两个是任何数据库都离不开的

基于代价的改写需要计算代价之后才能决定是否把 SQL 往好的方向改

完全基于代价也未必是准确的，因为当 SQL 中出现多表连接或者复杂的谓词时，优化器的选择率计算和代价计算是没有那么准确的，这个问题是所有的数据库优化器都存在的问题。

# 改写规则
基本上学术界和工业界那些广为人知的改写都支持

## 基于规则的改写规则
- 恒正、恒假条件简化
- 常量折叠
- SPJ 和非 SPJ 的视图合并
- 连接消除
- 非聚合类子查询提升
- 外连接消除
- 聚合类子查询提升
- 谓词推导
- Limit-k 下压
- Group by/window func/Distinct/Order by 消除

## 基于代价的改写规则
- Or-expansion
- Group by replacement
- 窗口函数改写
- Semi to Inner 改写
- 子查询合并

# 执行引擎
## 火山模型
传统的火山模型，也就是迭代器模型。执行计划由多个算子组成，每个算子由标准的接口实现，即 open/next/close 这 3 个接口
- open 接口：初始化算子执行需要的上下文信息。
- next 接口：从下层算子一行一行的获取数据，经过计算后会向上层算子返回一行数据。整个模型是一个数据拉取的模型。
- close 接口：执行结束后对算子执行的相关信息进行清理。

这个模型的好处在于实现非常简单，并且非常灵活，易于扩展。每个算子之间的实现是完全解耦的。如果需要新实现一个算子，比如实现了 Hash group by 算子，还要实现一个 Merge group by 算子，此时完全不需要考虑 Hash group by 算子的逻辑，按照接口的约定实现一个新的逻辑算子就可以，之后优化器会根据需要选择使用这个算子。

## 向量化执行引擎
- 向量化处理逻辑
- 硬件特性挖掘（预取、SIMD 等）
- Cache-aware 算子优化
- 基于编码的 filter 下压

向量化的实现主要涉及以下几个方面的改造：
- 算子向量化
- 表达式向量化
- 存储层向量化

对于算子的实现，以前执行引擎是按单行迭代的方式去实现算子，现在则是按 batch 进行迭代，算子实现的方式会发生比较大的改变。这种按 batch 迭代的方式在算子里面进行数据处理时也是按 batch 去处理。这样就能比较多的用到一些硬件的特性（如内存预取）。

# SQL 测试的工具
MysqlTest 和 RQG

# 性能测试
性能测试框架的要求：
- 可自动化回归
- 准入基线
- 多指标判断性能不下降
- 添加场景成本低
- 一定的权威性和广泛的认可度
- 场景经典

基于以上要求，筛选出 Sysbench、TPCC、TPCH 这 3 种经典的性能测试工具。

## Sysbench
Sysbench 是一个支持多线程基准测试工具，在数据库性能测试中使用广泛，它最大的优点是可以通过 lua 自定义
场景，添加新场景成本低，便于场景持续积累，具有很高的灵活性。
## TPCC
TPCC 是 OLTP 领域中最经典、最受认可的 benchmark 模型，模拟的是经典的商品销售模型。
其中有 9 张表，通过仓库的数量 W 调整数据规模，TPCC 各表之间数据比例固定
## TPCH
TPCH 是最为流行的 OLAP workload 的 benchmark，TPCH 是用来评估在线分析处理的基准程序，主要模拟了
供应商和采购商之间的交易行为，其中包含针对 8 张表的 22 条分析型查询。

# 稳定性测试
稳定性测试的核心思想是 workload + 容灾测试，其中 workload 使用 Sysbench、TPCC、TPCH 等测试工具来模拟压力，容灾测试使用混沌测试工具 ChaosBalde 来模拟 CPU、磁盘、网络、IO、Pod 等故障。


